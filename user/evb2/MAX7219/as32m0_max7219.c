#include "as32m0_max7219.h"

const uint8_t char_buf[95*8] ={
0x00, 0x00, 0x00, 0x00, 0x0, 0x0, 0x0, 0x0,		// SPACE
0x8, 0x8, 0x8, 0x8, 0x0, 0x0, 0x8, 0x0,		// !	
0x14, 0x14, 0x14, 0x0, 0x0, 0x0, 0x0, 0x0, // "	
0x14, 0x14, 0x3e, 0x14, 0x3e, 0x14, 0x14, 0x0,  // #
0x10, 0x3c, 0x50, 0x38, 0x14, 0x78, 0x10, 0x0, // $	
0x30, 0x31, 0x2, 0x4, 0x8, 0x13, 0x23, 0x0, // %	
0x18, 0x24, 0x28, 0x10, 0x2a, 0x24, 0x1a, 0x0, // &	
0xc, 0x4, 0x8, 0x0, 0x0, 0x0, 0x0, 0x0, //'	
0x10, 0x20, 0x40, 0x40, 0x40, 0x20, 0x10, 0x0, // (
0x10, 0x8, 0x4, 0x4, 0x4, 0x8, 0x10, 0x0, // )	
0x0, 0x0, 0x10, 0x54, 0x38, 0x54, 0x10, 0x0, //	*
0x0, 0x0, 0x10, 0x10, 0x7c, 0x10, 0x10, 0x0, // +	
0x0, 0x0, 0x0, 0x0, 0x18, 0x8, 0x10, 0x0, //,	
0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,//-	
0x0, 0x0, 0x0, 0x0, 0x30, 0x30, 0x0, 0x0, // .
0x0, 0x0, 0x4, 0x8, 0x10, 0x20, 0x0, 0x0, // '/'
0x3c, 0x42, 0x46, 0x4a, 0x52, 0x62, 0x42, 0x3c,//0
0x18, 0x28, 0x48, 0x8, 0x8, 0x8, 0x8, 0x1c,//1
0x7E,0x2,0x2,0x7E,0x40,0x40,0x40,0x7E,//2
0x7E,0x2,0x2,0x7E,0x2,0x2,0x2,0x7E,//3
0x8,0x18,0x28,0x48,0xFE,0x8,0x8,0x8,//4
0x7C,0x40,0x40,0x7C,0x4,0x4,0x4,0x7C,//5
0x3C,0x20,0x20,0x3C,0x24,0x24,0x3C,0x0,//6
0x3E,0x22,0x4,0x8,0x8,0x8,0x8,0x8,//7
0x3c, 0x42, 0x42, 0x7e, 0x42, 0x42, 0x3c, 0x0,//8
0x3E,0x22,0x22,0x3E,0x2,0x2,0x2,0x3E,//9	
0x0, 0x18, 0x18, 0x0, 0x18, 0x18, 0x0, 0x0,//:	
0x0, 0x18, 0x18, 0x0, 0x18, 0x8, 0x10, 0x0, //;
0x4, 0x8, 0x10, 0x20, 0x10, 0x8, 0x4, 0x0, //<
0x0, 0x0, 0x0, 0x7e, 0x0, 0x7e, 0x0, 0x0, //=	
0x20, 0x10, 0x8, 0x4, 0x8, 0x10, 0x20, 0x0,//>	
0x38, 0x44, 0x4, 0x8, 0x10, 0x0, 0x10, 0x0,//?	
0x38, 0x44, 0x4, 0x34, 0x54, 0x54, 0x38, 0x0, //@
0x18,0x24,0x42,0x42,0x42,0x7e,0x42,0x42,//A
0x3C,0x22,0x22,0x3E,0x22,0x22,0x3C,0x0,//B
0x3C,0x40,0x40,0x40,0x40,0x40,0x40,0x3C,//C
0x7C,0x42,0x42,0x42,0x42,0x42,0x7C,0x0,//D
0x7C,0x40,0x40,0x7C,0x40,0x40,0x40,0x7C,//E
0x7C,0x40,0x40,0x7C,0x40,0x40,0x40,0x40,//F
0x3C,0x40,0x40,0x40,0x40,0x44,0x44,0x3C,//G
0x44,0x44,0x44,0x7C,0x44,0x44,0x44,0x44,//H
0x7C,0x10,0x10,0x10,0x10,0x10,0x10,0x7C,//I
0x3C,0x8,0x8,0x8,0x8,0x8,0x48,0x30,//J
0x0,0x24,0x28,0x30,0x20,0x30,0x28,0x24,//K
0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x7C,//L
0x81,0xC3,0xA5,0x99,0x81,0x81,0x81,0x81,//M
0x0,0x42,0x62,0x52,0x4A,0x46,0x42,0x0,//N
0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x3C,//O
0x3C,0x22,0x22,0x22,0x3C,0x20,0x20,0x20,//P
0x1C,0x22,0x22,0x22,0x22,0x26,0x22,0x1D,//Q
0x3C,0x22,0x22,0x22,0x3C,0x24,0x22,0x21,//R
0x1e, 0x20, 0x20, 0x1c, 0x2, 0x2, 0x3c, 0x0,//S
0x0,0x3E,0x8,0x8,0x8,0x8,0x8,0x8,//T
0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3c,//U
0x42,0x42,0x42,0x42,0x42,0x42,0x24,0x18,//V
0x0,0x49,0x49,0x49,0x49,0x2A,0x1C,0x0,//W
0x0,0x41,0x22,0x14,0x8,0x14,0x22,0x41,//X
0x41,0x22,0x14,0x8,0x8,0x8,0x8,0x8,//Y
0x0,0x7F,0x2,0x4,0x8,0x10,0x20,0x7F,//Z
0x38,0x20,0x20,0x20,0x20,0x20,0x20,0x38,//[
0x0, 0x40, 0x20, 0x10, 0x8, 0x4, 0x2, 0x0,//     
0x1c, 0x4, 0x4, 0x4, 0x4, 0x4, 0x4, 0x1c,  // ]
0x18, 0x24, 0x24, 0x0, 0x0, 0x0, 0x0, 0x0, // ^
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7e,  // _
0x10, 0x8, 0x4, 0x0, 0x0, 0x0, 0x0, 0x0, //'
 0x0, 0x0, 0x1c, 0x2, 0x1e, 0x22, 0x1e, 0x0, //a
0x40, 0x40, 0x40, 0x7c, 0x42, 0x42, 0x42, 0x7c,//b
0x0, 0x0, 0x0, 0x38, 0x40, 0x40, 0x40, 0x38, //c
0x2, 0x2, 0x2, 0x2, 0x1e, 0x22, 0x22, 0x1e,  //d
0x0, 0x0, 0x0, 0x30, 0x48, 0x78, 0x40, 0x78, //e
0xc, 0x12, 0x10, 0x38, 0x10, 0x10, 0x10, 0x0, //f
0xc, 0x12, 0x12, 0xe, 0x2, 0x12, 0x12, 0x1e,//g
0x20, 0x20, 0x20, 0x20, 0x3c, 0x24, 0x24, 0x24, //h
0x0, 0x0, 0x10, 0x0, 0x10, 0x10, 0x10, 0x10, //i
0x8, 0x0, 0x8, 0x8, 0x8, 0x8, 0x28, 0x38,		// j
0x40, 0x40, 0x40, 0x48, 0x50, 0x60, 0x50, 0x48,//k
0x18, 0x8, 0x8, 0x8, 0x8, 0x8, 0x1c, 0x0,//l
0x0, 0x0, 0x0, 0x68, 0x54, 0x54, 0x44, 0x0,  //m
0x0, 0x0, 0x0, 0x58, 0x64, 0x44, 0x44, 0x0,   //n
0x0, 0x0, 0x0, 0x1c, 0x22, 0x22, 0x22, 0x1c,   //o
0x0, 0x0, 0x78, 0x44, 0x78, 0x40, 0x40, 0x0,		//p
0x0, 0x0, 0x1a, 0x26, 0x1e, 0x2, 0x2, 0x0,			//q
 0x0, 0x0, 0x58, 0x64, 0x40, 0x40, 0x40, 0x0,		//r
  0x0, 0x0, 0x38, 0x40, 0x38, 0x4, 0x78, 0x0, //s
0x20, 0x20, 0x70, 0x20, 0x20, 0x24, 0x18, 0x0, //t
0x0, 0x44, 0x44, 0x44, 0x4c, 0x34, 0x4, 0x0, //u
0x0, 0x0, 0x44, 0x44, 0x44, 0x28, 0x10, 0x0, //v
0x0, 0x0, 0x44, 0x44, 0x54, 0x54, 0x28, 0x0, //w
0x0, 0x0, 0x44, 0x28, 0x10, 0x28, 0x44, 0x0, //x
 0x0, 0x0, 0x44, 0x44, 0x3c, 0x4, 0x38, 0x0, //y
 0x0, 0x0, 0x78, 0x8, 0x10, 0x20, 0x78, 0x0, //z
 0x8, 0x10, 0x10, 0x20, 0x10, 0x10, 0x8, 0x0,//(
 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x0,//|
 0x10, 0x8, 0x8, 0x4, 0x8, 0x8, 0x10, 0x0, //}
// 0x0, 0x0, 0x40, 0x38, 0x4, 0x0, 0x0, 0x0, //~
  0x1, 0x1, 0x0, 0x1, 0x1, 0x1, 0x0, 0x1  // char 32 - " "
};


void MAX7219_write(uint8_t addr, uint8_t data){
	MAX7219_CSn_SET(0);
  APB_SPI->DataRegister = addr;
	APB_SPI->DataRegister = data;
  apSSP_DeviceEnable(APB_SPI);
  while(apSSP_DeviceBusyGet(APB_SPI));
  apSSP_DeviceDisable(APB_SPI);
  apSSP_ReadFIFO(APB_SPI);
  apSSP_ReadFIFO(APB_SPI);
	MAX7219_CSn_SET(1);
}
void MAX7219_multi_write(uint8_t addr, uint8_t data){
  APB_SPI->DataRegister = addr;
	APB_SPI->DataRegister = data;
  apSSP_DeviceEnable(APB_SPI);
  while(apSSP_DeviceBusyGet(APB_SPI));
  apSSP_DeviceDisable(APB_SPI);
  apSSP_ReadFIFO(APB_SPI);
  apSSP_ReadFIFO(APB_SPI);
}
void MAX7219_shutdown_on(void){
	MAX7219_write(0x0c, 0x00);
}
void MAX7219_normal_on(void){
	MAX7219_write(0x0c, 0x01);
}

void MAX7219_dummy_cycle(uint32_t cycle){
	uint32_t i;
	MAX7219_CSn_SET(1);
	for(i=0; i<cycle;i++) {MAX7219_multi_write(0x0, 0x0);}
}

void MAX7219_ser_8x8_display_write(int32_t loc, uint8_t data[]){
	uint8_t i, j;
 if(loc < SER_NUM && loc >=0){
		for(i=0;i<8;i++){
			if(loc>0){ 
				MAX7219_CSn_SET(1);
				MAX7219_multi_write(i+1, data[i]);
				for(j=1;j<loc;j++){
					MAX7219_multi_write(0, 0);
				}
				MAX7219_write(0, 0);
			}
			else
				MAX7219_write(i+1, data[i]);
			MAX7219_dummy_cycle(SER_NUM-loc-1);
		}			
	}
}
uint32_t MAX7219_print_string(int32_t loc_m_word, char data[]){
	uint16_t i=0;
	while(data[i]!='\0' && i <32){
		MAX7219_ser_8x8_display_write(loc_m_word, MAX7219_char_lookup(data[i]));
	  i++;
		loc_m_word = loc_m_word - 1;
	}
	return i;
}


void MAX7219_clear_all(void){
 uint16_t i;
  for(i=0;i<8;i++){
		MAX7219_write(i+1, 0x00);
	}
	for(i=0;i<(SER_NUM*8 - 8);i++){
		MAX7219_write(0x00, 0x00);
	}
}
void MAX7219_init(void){
	uint16_t i;
	MAX7219_write(0x09, 0x00); // BCD Code
	MAX7219_write(0x0a, 0x03); // Brightness
	MAX7219_write(0x0b, 0x07); // 8 Seg
	MAX7219_write(0x0c, 0x01); // Normal mode
	MAX7219_write(0x0f, 0x00); // Normal display
	for(i=0;i<(SER_NUM + 5);i++){
		MAX7219_write(0x00, 0x00);
	}
}

uint8_t* MAX7219_char_lookup(uint8_t character){
	uint8_t *ptr;
	uint8_t tmp;
	if(character >= ' ' && character <='~'){
		tmp = character - 0x20;
//		ptr = &char_buf[tmp*8];
	}
		
	return ptr;
}




